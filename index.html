<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">

<meta charset="UTF-8">
<title>Inventaire Alimentaire</title>
<style>
body {font-family: Arial, sans-serif; padding: 15px; margin: 0; width: 100%; class="dark"; }
h1 { color: #2c3e50; text-align: center; }
label { display: block; margin-top: 10px; }
input, select, button { margin: 5px 0; padding: 10px; font-size: 1em; width: 100%; box-sizing: border-box; }
.urgent {color: red; font-weight: bold; display: flex; align-items: center; flex: 1; }
.ok {color: black; display: flex; align-items: center; flex: 1; }
ul { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; margin-top: 10px; }
li { margin: 5px 0; padding: 5px; border-bottom: 1px solid #ccc; word-wrap: break-word; }
li {display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
button.small {padding: 6px 10px; font-size: 0.9em; min-width: 90px; }
@media (max-width: 600px) {
  body { padding: 10px; }
  input, select, button { width: 100%; }
}
.actions {display: inline-flex; gap: 6px; margin-left: 10px; }
  
.dark {background: #121212; color: #e0e0e0; }
.dark input, .dark select, .dark button {background: #1e1e1e; color: #e0e0e0; border: 1px solid #444; }
.dark li {border-bottom: 1px solid #333; }
.toggle {margin: 10px 0; }
.dark strong, .dark li span, .dark h1, .dark h2 {color: #ffffff; }

.form-section {margin-bottom: 25px; }
  
html, body {height: 100%;}

#listeAliments {min-height: calc(100vh - 300px); overflow-y: auto; }

.nav {display: flex; gap: 10px; margin-bottom: 15px; }

.nav button {flex: 1; }

</style>
</head>
<body>

<h1>Inventaire Alimentaire</h1>
  
<nav class="nav">
  <button style="width:auto; padding:10px; font-size:1em;" onclick="afficherPage('inventaire')">üì¶ Inventaire</button>
  <button style="width:auto; padding:10px; font-size:1em;" onclick="afficherPage('repas')">üçΩÔ∏è Repas</button>
</nav>

<button class="toggle" onclick="toggleDarkMode()">üåô Mode sombre</button>


<div id="page-inventaire" class="page"> 

  <div style="margin-bottom:10px;">
    <button onclick="exporterInventaire()">üíæ Sauvegarder</button>
    <input type="file" id="importFile" accept=".json" onchange="importerInventaire(event)">
  </div>
  
  <label>Nom :</label>
  <input type="text" id="nom" placeholder="Nom de l'aliment">

  <label>Quantit√© :</label>
  <input type="number" id="quantite" placeholder="Quantit√©">

  <label>Unit√© :</label>
  <input type="text" id="unite" placeholder="Ex: g, litre, pcs">

  <label>Date de p√©remption :</label>
  <div style="display: flex; align-items: center; gap: 10px;">
    <input type="date" id="peremption">
    <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
      <input type="checkbox" id="sansDate" style="transform: scale(1.5);">
      <span style="white-space: nowrap;">Pas de DLC</span>
    </label>
  </div>

  <label>Cat√©gorie :</label>
  <select id="categorie">
    <option value="Choisir cat√©gorie">Choisir cat√©gorie</option>
    <option value="Boisson">Boisson</option>
    <option value="Produit laitier">Produit laitier</option>
    <option value="L√©gume">L√©gume</option>
    <option value="Fruit">Fruit</option>
    <option value="Viande">Viande</option>
    <option value="Poisson">Poisson</option>
    <option value="F√©culent">F√©culent</option>
    <option value="Sucr√©">Sucr√©</option>
    <option value="Sauce">Sauce</option>
    <option value="Epice">Epice</option>
    <option value="Sec">Sec</option>
    <option value="Plat pr√©par√©">Plat pr√©par√©</option>
    <option value="test">test</option>
  </select>


  <div class="form-section">
    <button type="button" onclick="ajouterOuModifierAliment()">Ajouter</button>
  </div>


  <input type="text" id="recherche" placeholder="üîç Rechercher un aliment..." oninput="afficherAliments()">
  <h2>Liste des aliments :</h2>
  <ul id="listeAliments"></ul>
  
</div>

<div id="page-repas" class="page" style="display:none;">
  <h2>üçΩÔ∏è Repas de la semaine</h2>

  <p>Planifie les repas de la semaine :</p>
  
<div style="display: flex; align-items: flex-end; gap: 10px; margin-top: 20px;">
  <table border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          <th>Jour</th>
          <th>Petit-d√©jeuner</th>
          <th>D√©jeuner</th>
          <th>D√Æner</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Lundi</td>
          <td><input type="text" class="repas" data-jour="Lundi" data-repas="Petit-d√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Lundi" data-repas="D√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Lundi" data-repas="D√Æner"></td>
        </tr>
        <tr>
          <td>Mardi</td>
          <td><input type="text" class="repas" data-jour="Mardi" data-repas="Petit-d√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Mardi" data-repas="D√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Mardi" data-repas="D√Æner"></td>
        </tr>
        <tr>
          <td>Mercredi</td>
          <td><input type="text" class="repas" data-jour="Mercredi" data-repas="Petit-d√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Mercredi" data-repas="D√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Mercredi" data-repas="D√Æner"></td>
        </tr>
        <tr>
          <td>Jeudi</td>
          <td><input type="text" class="repas" data-jour="Jeudi" data-repas="Petit-d√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Jeudi" data-repas="D√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Jeudi" data-repas="D√Æner"></td>
        </tr>
        <tr>
          <td>Vendredi</td>
          <td><input type="text" class="repas" data-jour="Vendredi" data-repas="Petit-d√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Vendredi" data-repas="D√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Vendredi" data-repas="D√Æner"></td>
        </tr>
        <tr>
          <td>Samedi</td>
          <td><input type="text" class="repas" data-jour="Samedi" data-repas="Petit-d√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Samedi" data-repas="D√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Samedi" data-repas="D√Æner"></td>
        </tr>
        <tr>
          <td>Dimanche</td>
          <td><input type="text" class="repas" data-jour="Dimanche" data-repas="Petit-d√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Dimanche" data-repas="D√©jeuner"></td>
          <td><input type="text" class="repas" data-jour="Dimanche" data-repas="D√Æner"></td>
        </tr>
      </tbody>
    </table>
  
    <button onclick="nouvelleSemaine()" 
          style="
            background-color:#e74c3c;
            color:white;
            padding: 6px 12px;
            border:none;
            border-radius:5px;
            cursor:pointer;
            font-size: 0.9em;
            height: fit-content;
            width: auto !important;
          ">
       Nouvelle semaine
    </button>
</div>

  <div style="margin-top:10px;">
    <button onclick="sauvegarderRepas()">üíæ Sauvegarder la semaine</button>
    <br>
    <button onclick="chargerRepas()">üîÑ Charger la semaine</button>
    <br>
    <button onclick="genererListeCourses()">üõí G√©n√©rer la liste de courses</button>
    <br>
  </div>
  <div id="repasSemaine"></div>

</div>

<script>
if (localStorage.getItem("darkMode") === "true") {
  document.body.classList.add("dark");
}

function toggleDarkMode() {
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
}

let aliments = [];
let indexEnCours = -1;

// Charger les aliments depuis localStorage
function chargerAliments() {
  const data = localStorage.getItem("aliments");
  if(data) aliments = JSON.parse(data);
}

// Sauvegarder les aliments dans localStorage
function sauvegarderAliments() {
  localStorage.setItem("aliments", JSON.stringify(aliments));
}

// Calculer les jours restants avant p√©remption
function calculerJoursRestants(dateString) {
  const aujourdHui = new Date();
  const peremption = new Date(dateString);
  const diffTime = peremption - aujourdHui;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return diffDays < 0 ? 0 : diffDays;
}

// Afficher la liste tri√©e par cat√©gorie
function afficherAliments() {
  const recherche = document.getElementById("recherche").value.toLowerCase();
  const ul = document.getElementById("listeAliments");
  ul.innerHTML = "";
  
  const ordreCategorie = ["F√©culent", "Produit laitier", "Viande", "Poisson", "Fruit", "L√©gume", "Sucr√©", "Sec", "Sauce", "Epice", "Boisson", " Plat pr√©par√©"];
  // Trier par cat√©gorie
  aliments.sort((a,b) => ordreCategorie.indexOf(a.categorie) - ordreCategorie.indexOf(b.categorie));

  let categorieActuelle = "";

  aliments.forEach((aliment, index) => {
    if(!aliment.nom.toLowerCase().includes(recherche)) return;
    // Si on change de cat√©gorie ‚Üí afficher le titre
    if(aliment.categorie !== categorieActuelle) {
      categorieActuelle = aliment.categorie;
      const titre = document.createElement("li");
      titre.innerHTML = `<strong style="font-size:1.2em; color:#2c3e50;">${categorieActuelle}</strong>`;
      ul.appendChild(titre);
    }
    
    const li = document.createElement("li");
    const joursRestants = calculerJoursRestants(aliment.peremption);
    let texte = `${aliment.nom} - ${aliment.quantite} ${aliment.unite}`;

    if (aliment.peremption) {
      texte += ` - ${joursRestants} jour(s) restant`;
    } else {
      texte += " - Dur√©e illimit√©e";
    }

    if (aliment.peremption && calculerJoursRestants(aliment.peremption) <= 3) {
      li.className = "urgent";
      texte += " - URGENT !";
    } else {
      li.className = "ok";
    }
    
    const spanTexte = document.createElement("span");
    spanTexte.textContent = texte;
    li.appendChild(spanTexte);

    // Boutons
    const btnModifier = document.createElement("button");
    btnModifier.textContent = "Modifier";
    btnModifier.className = "small";
    btnModifier.onclick = () => preRemplirFormulaire(index);

    const btnSupprimer = document.createElement("button");
    btnSupprimer.textContent = "Supprimer";
    btnSupprimer.className = "small";
    btnSupprimer.onclick = () => supprimerAliment(index);

    const actions = document.createElement("span");
    actions.className = "actions";
    actions.appendChild(btnModifier);
    actions.appendChild(btnSupprimer);

    li.appendChild(actions);
    ul.appendChild(li);
  });
}

// Ajouter ou modifier un aliment
function ajouterOuModifierAliment() {
  const nom = document.getElementById("nom").value;
  const quantite = document.getElementById("quantite").value;
  const unite = document.getElementById("unite").value;
  const sansDate = document.getElementById("sansDate").checked;
  const peremption = sansDate ? null : document.getElementById("peremption").value;
  const categorie = document.getElementById("categorie").value;

  if(!nom || !quantite || !unite || !categorie) {
    alert("Veuillez remplir tous les champs !");
    return;
  }

  const nouvelAliment = {nom, quantite, unite, peremption, categorie};

  if(indexEnCours === -1) {
    aliments.push(nouvelAliment);
  } else {
    aliments[indexEnCours] = nouvelAliment;
    indexEnCours = -1;
    document.querySelector("button[onclick='ajouterOuModifierAliment()']").textContent = "Ajouter";
  }

  // R√©initialiser le formulaire
  document.getElementById("nom").value = "";
  document.getElementById("quantite").value = "";
  document.getElementById("unite").value = "";
  document.getElementById("peremption").value = "";
  document.getElementById("categorie").value = "Choisir cat√©gorie";
  document.getElementById("sansDate").checked = false; 


  sauvegarderAliments();
  afficherAliments();
}

// Pr√©-remplir le formulaire pour modifier
function preRemplirFormulaire(index) {
  const aliment = aliments[index];
  document.getElementById("nom").value = aliment.nom;
  document.getElementById("quantite").value = aliment.quantite;
  document.getElementById("unite").value = aliment.unite;
  document.getElementById("peremption").value = aliment.peremption;
  document.getElementById("categorie").value = aliment.categorie;
  indexEnCours = index;
  document.querySelector("button[onclick='ajouterOuModifierAliment()']").textContent = "Modifier";
}

// Supprimer un aliment
function supprimerAliment(index) {
  if(confirm("Voulez-vous vraiment supprimer cet aliment ?")) {
    aliments.splice(index, 1);
    sauvegarderAliments();
    afficherAliments();
  }
}

// Initialisation
chargerAliments();
afficherAliments();

function exporterInventaire() {
  const dataStr = JSON.stringify(aliments, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "inventaire.json";
  a.click();

  URL.revokeObjectURL(url);
}

function importerInventaire(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      aliments = JSON.parse(e.target.result);
      sauvegarderAliments();
      afficherAliments();
      alert("Inventaire restaur√© avec succ√®s !");
    } catch {
      alert("Fichier invalide");
    }
  };
  reader.readAsText(file);
}

function afficherPage(page) {
  document.getElementById("page-inventaire").style.display = "none";
  document.getElementById("page-repas").style.display = "none";

  document.getElementById("page-" + page).style.display = "block";
}

function sauvegarderRepas() {
  const repasData = {};
  document.querySelectorAll('.repas').forEach(input => {
    const jour = input.dataset.jour;
    const typeRepas = input.dataset.repas;
    if (!repasData[jour]) repasData[jour] = {};
    repasData[jour][typeRepas] = input.value;
  });
  localStorage.setItem('repasSemaine', JSON.stringify(repasData));
  alert("Repas sauvegard√©s !");
}

function chargerRepas() {
  const repasData = JSON.parse(localStorage.getItem('repasSemaine'));
  if (!repasData) return;

  document.querySelectorAll('.repas').forEach(input => {
    const jour = input.dataset.jour;
    const typeRepas = input.dataset.repas;
    input.value = repasData[jour] ? repasData[jour][typeRepas] || '' : '';
  });
}

let categoriesCourses = JSON.parse(localStorage.getItem("categoriesCourses")) || {};
const toutesCategories = ["F√©culent", "Produit laitier", "Viande", "Poisson", "Fruit", "L√©gume", "Sucr√©", "Sauce", "Epice", "Boisson", "Conserve", "Produit du monde", "Hygi√®ne"];
  
function genererListeCourses() {

  let inventaire = JSON.parse(localStorage.getItem('aliments')) || {};
  const repasData = JSON.parse(localStorage.getItem('repasSemaine')) || {};
  let categories = JSON.parse(localStorage.getItem("coursesCategories")) || {};

  const totalDemandes = {};

  alert("Inventaire charg√© 15 : " + JSON.stringify(inventaire));

  // üîÅ Convertisseur d‚Äôunit√©s
  function normaliserUnite(qte, unite) {

    unite = (unite || "pcs").toLowerCase();

    if (unite === "kg") return { qte: qte * 1000, unite: "g" };
    if (unite === "l")  return { qte: qte * 1000, unite: "ml" };

    return { qte, unite };
  }


  // =========================
  // CALCUL DES BESOINS
  // =========================
  Object.values(repasData).forEach(jour => {

    Object.values(jour).forEach(texteRepas => {

      if (!texteRepas) return;

      const aliments = texteRepas.split(',').map(a => a.trim());

      aliments.forEach(item => {

        // Formats accept√©s :
        // Banane
        // Banane 2
        // Banane 200 g
        // Fromage 0.3 kg
        const match = item.match(/^(.+?)\s*(\d+(?:\.\d+)?)?\s*(\w+)?$/);
        if (!match) return;

        const nom = match[1].trim();
        const qte = Number(match[2]) || 1;
        const unite = match[3] || "pcs";

        const norm = normaliserUnite(qte, unite);

        if (!totalDemandes[nom]) {
          totalDemandes[nom] = { qte: 0, unite: norm.unite };
        }

        totalDemandes[nom].qte += norm.qte;

        if (!categories[nom]) categories[nom] = "Autres";
      });
    });
  });


  // =========================
  // COMPARER AVEC INVENTAIRE
  // =========================
  const courses = {};

  Object.keys(totalDemandes).forEach(nom => {

    const besoinData = totalDemandes[nom];

    const trouve = inventaire.find(a =>
      a.nom.toLowerCase() === nom.toLowerCase()
    );

    let stock = 0;

    if (trouve) {
      const norm = normaliserUnite(Number(trouve.quantite), trouve.unite);
      stock = norm.qte;
    }

    const manque = Math.max(besoinData.qte - stock, 0);

    if (manque > 0) {
      courses[nom] = {
        qte: manque,
        unite: besoinData.unite
      };
    }
  });


  // =========================
  // AFFICHAGE
  // =========================
  const container = document.getElementById("repasSemaine");
  container.innerHTML = "<h3 style='font-size:1.4em;'>üõí Liste de courses</h3>";

  if (Object.keys(courses).length === 0) {
    container.innerHTML += "<p>‚úÖ Tout est d√©j√† en stock.</p>";
    return;
  }

  const ordreCategories = [
    "Autres",
    "F√©culent","Produit laitier","Viande","Poisson",
    "Fruit","L√©gume","Sucr√©","Sauce",
    "Epice","Boisson","Conserve", "Produit du monde", "Hygi√®ne"
  ];


  ordreCategories.forEach(categorie => {

    const items = Object.keys(courses)
      .filter(nom => categories[nom] === categorie);

    if (items.length === 0) return;

    const titre = document.createElement("p");
    titre.textContent = categorie;
    titre.style.fontWeight = "bold";
    titre.style.fontSize = "1.3em";
    container.appendChild(titre);

    const ul = document.createElement("ul");

    items.forEach(nom => {

      const li = document.createElement("li");
      li.style.display = "flex";
      li.style.gap = "10px";
      li.style.fontSize = "1.1em";

      const span = document.createElement("span");
      span.style.flex = "1";

      const data = courses[nom];

      span.textContent = `${nom} ${data.qte} ${data.unite}`;

      const select = document.createElement("select");

      const def = document.createElement("option");
      def.textContent = "Modifier";
      def.selected = true;
      def.disabled = true;
      select.appendChild(def);

      ordreCategories.forEach(cat => {
        const o = document.createElement("option");
        o.value = cat;
        o.textContent = cat;
        select.appendChild(o);
      });

      select.onchange = () => {
        categories[nom] = select.value;
        localStorage.setItem("coursesCategories", JSON.stringify(categories));
        genererListeCourses();
      };

      li.appendChild(span);
      li.appendChild(select);
      ul.appendChild(li);
    });

    container.appendChild(ul);
  });

  localStorage.setItem("coursesCategories", JSON.stringify(categories));
}

function nouvelleSemaine() {
  if (!confirm("Voulez-vous vraiment commencer une nouvelle semaine ? Toutes les cases seront vid√©es.")) return;

  // Vider toutes les cases du tableau
  document.querySelectorAll('.repas').forEach(input => input.value = '');

  // Supprimer les donn√©es de la semaine dans le localStorage
  localStorage.removeItem('repasSemaine');

  // Supprimer aussi la liste de courses g√©n√©r√©e
  document.getElementById("repasSemaine").innerHTML = "";

  alert("Nouvelle semaine pr√™te ! Toutes les cases ont √©t√© vid√©es.");
}


</script>
  
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker enregistr√©"))
    .catch(err => console.error("SW erreur", err));
}
</script>

</body>
</html>




































































































